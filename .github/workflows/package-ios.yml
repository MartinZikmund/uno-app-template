name: Build iOS Packages

on:
  workflow_dispatch:

env:
  # App Configuration
  APP_NAME: AppTemplate
  DOTNET_VERSION: 10.0.x
  SOLUTION_FILE: src/AppTemplate.slnx
  PROJECT_PATH: src/AppTemplate
  PROJECT_FILE: src/AppTemplate/AppTemplate.csproj
  IOS_TARGET_FRAMEWORK: net10.0-ios

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build_ios:
    runs-on: macos-26

    env:
      STEP_TIMEOUT_MINUTES: 60

      DOTNET_NOLOGO: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      ContinuousIntegrationBuild: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.sln*', '**/*.csproj', '**/Directory.Packages.props', '**/global.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            ${{ env.DOTNET_VERSION }}

      - name: Install .NET workloads
        run:
          dotnet workload restore "${{ env.SOLUTION_FILE }}"

      - name: Select Xcode Latest
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show Xcode version (debug)
        run: xcodebuild -version

      - name: Download iOS Platform (workaround for https://github.com/actions/runner-images/issues/13275)
        run: xcodebuild -downloadPlatform iOS

      # --- Code signing: import Apple Distribution cert into a temp keychain ---
      - name: Import signing certificate
        uses: apple-actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.APPLE_DISTRIBUTION_P12_BASE64 }}
          p12-password: ${{ secrets.APPLE_P12_PASSWORD }}

      # --- Provisioning profile install (App Store) ---
      - name: Install provisioning profile
        shell: bash
        run: |
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > "$HOME/Library/MobileDevice/Provisioning Profiles/AppStore.mobileprovision"
          ls -l "$HOME/Library/MobileDevice/Provisioning Profiles"

      - name: Restore solution
        run: dotnet restore "${{ env.SOLUTION_FILE }}"

      # Build an archive and produce a signed .ipa
      - name: Publish iOS (signed .ipa)
        run: |
          dotnet publish "${{ env.PROJECT_FILE }}" -c Release -f ${{ env.IOS_TARGET_FRAMEWORK }} -r ios-arm64 \
            -p:ArchiveOnBuild=true \
            -p:BuildIpa=true \
            -p:CodesignKey="${{ secrets.APPLE_CODESIGN_KEY }}" \
            -p:CodesignTeamId="${{ secrets.APPLE_TEAM_ID }}" \
            -p:CodesignProvision="${{ secrets.APPLE_PROVISIONING_PROFILE_UUID }}"

      - name: Upload .ipa
        uses: actions/upload-artifact@v4
        with:
          name: iOS_IPA
          path: |
            ${{ env.PROJECT_PATH }}/bin/Release/${{ env.IOS_TARGET_FRAMEWORK }}/ios-arm64/publish/*.ipa
      
      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v3
        with:
          app-path: "${{ env.PROJECT_PATH }}/bin/Release/${{ env.IOS_TARGET_FRAMEWORK }}/ios-arm64/publish/${{ env.APP_NAME }}.ipa"
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}